#cloud-config
groups:
  - www-data
users:
  - name: deploy
    groups: www-data
    sudo: ALL=(ALL) NOPASSWD:ALL
    passwd: $6$rounds=4096$fxdFCrS5y/aq$XcX9oBK2iSsW4wdNDLh7ZLOVyPPNlrkRV.a2MoJkOkM9N3bvtXP3VYE/IMUbXq6YgkZmrYsgtWRo.BtX5DXvb.
    lock_passwd: false
    shell: /bin/bash
package_update: true 
packages:
  - build-essential
  - python3-pip
  - python3-venv
  - nginx-core
runcmd:
  - cd /home/deploy
  - pyvenv env
  - mkdir /home/deploy/www-app
  - mkdir /home/deploy/www-app/static
  - mkdir /home/deploy/www-app/media
  - chown -R deploy /home/deploy



  
write_files:
  - path: /home/deploy/uwsgi_param
    owner: deploy:deploy
    content: |
      uwsgi_param  QUERY_STRING       $query_string;
      uwsgi_param  REQUEST_METHOD     $request_method;
      uwsgi_param  CONTENT_TYPE       $content_type;
      uwsgi_param  CONTENT_LENGTH     $content_length;

      uwsgi_param  REQUEST_URI        $request_uri;
      uwsgi_param  PATH_INFO          $document_uri;
      uwsgi_param  DOCUMENT_ROOT      $document_root;
      uwsgi_param  SERVER_PROTOCOL    $server_protocol;
      uwsgi_param  REQUEST_SCHEME     $scheme;
      uwsgi_param  HTTPS              $https if_not_empty;

      uwsgi_param  REMOTE_ADDR        $remote_addr;
      uwsgi_param  REMOTE_PORT        $remote_port;
      uwsgi_param  SERVER_PORT        $server_port;
      uwsgi_param  SERVER_NAME        $server_name;
  - path: /home/deploy/nginx-config
    owner: root:root
    content: | 
      upstream django {
        server 127.0.0.1:8000;
      }

      server {
        listen      80;
        server_name _; # substitute your machine's IP address or FQDN
        charset     utf-8;
        
        # django collected static files should be served by nginx
        location /static {
          alias /home/deploy/www-app/static; 
        }
        
        # if we had user defined media it would have a separate route as well
        
        # all non-static content should be handled by django
        location / {
          uwsgi_pass  django;
          include     /home/deploy/www-app/uwsgi_params; # the uwsgi_params file you installed
        }
      }
  - path: /home/deploy/uwsgi.ini
    owner: deploy:deploy
    content: |
      [uwsgi]

      # Django-related settings
      chdir           = /home/deploy/www-app/workshop
      module          = workshop.wsgi
      home            = /home/deploy/env

      master          = true
      processes       = 3
      socket            = :8000
      vacuum          = true
  
runcmd:
  - cd /home/deploy
  - pyvenv env
  - mkdir /home/deploy/www-app
  - mkdir /home/deploy/www-app/static
  - mkdir /home/deploy/www-app/media
  - chown -R deploy /home/deploy
